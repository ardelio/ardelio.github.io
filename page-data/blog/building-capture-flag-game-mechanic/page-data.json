{
    "componentChunkName": "component---src-pages-markdown-remark-frontmatter-slug-js",
    "path": "/blog/building-capture-flag-game-mechanic",
    "result": {"data":{"allPublishedPosts":{"distinctTags":["architecture","design","development","game","model","pattern","unity"]},"publishedPost":{"html":"<p>I wanted to implement a capture the flag game mechanic for my yet to be named game, which like many other projects of mine, will most likely disappear into obscurity.</p>\n<p>The game itself is a <a href=\"https://en.wikipedia.org/wiki/Multiplayer_online_battle_arena\">MOBA</a> (<em>Multiplayer Online Battle Arena</em>) where up to (<em>a yet to be determined number of</em>) players battle it out. Placed around the map will be villages that can be captured, granting the occupying player a trait (<em>a buff or skill</em>) and spawning NPCs (<em>Non Player Characters</em>) that will head off into the wilds in search of fame and glory.</p>\n<p>How might one build such a game mechanic, you might ask? Whilst there are many ways to skin a cat, per se, I have chosen to build the logic using a behavioural model called a State Machine or Finite State Machine.</p>\n<p>What we'll cover:</p>\n<ul>\n<li><a href=\"#what-is-a-finite-state-machine\">What is a Finite State Machine?</a></li>\n<li><a href=\"#identifying-the-behaviours-of-capturing-a-village\">Identifying the behaviours of capturing a village</a></li>\n<li><a href=\"#conceptualising-our-finite-state-machine\">Conceptualising our Finite State Machine</a></li>\n<li><a href=\"#coding-our-state-machine\">Coding our State Machine</a></li>\n<li><a href=\"#the-end-result\">The end result</a></li>\n</ul>\n<p><a name=\"what-is-a-finite-state-machine\"></a></p>\n<h1>What is a Finite State Machine?</h1>\n<p>A Finite State Machine (<em>FSM</em>) is an abstract machine that has a limited (<em>finite</em>) number of states. The machine can only be in one state at a time. Each state will have one or more conditions that will allow transition between one state and another.</p>\n<p>As an example, we can create a rudimentary and simple FSM that we can all relate to that models how Water can transition to Steam or Ice.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ac32a3d3065e6d76051223198baeb736/d4fe4/capture-flag-state-machine-water-example.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdiAuB//xAAYEAACAwAAAAAAAAAAAAAAAAARMQABAv/aAAgBAQABBQJWpkj/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAEBAAMAAAAAAAAAAAAAAAAhAAERIv/aAAgBAQAGPwJbpnO7/8QAGxAAAgEFAAAAAAAAAAAAAAAAAAExIUFRYYH/2gAIAQEAAT8hfTposlbnAqTB/9oADAMBAAIAAwAAABBwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABcQAQEBAQAAAAAAAAAAAAAAAAERIQD/2gAIAQEAAT8QGDU2rI7SE0CpHCjYtkzv/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Steam Water Ice State Machine\"\n        title=\"Steam Water Ice State Machine\"\n        src=\"/static/ac32a3d3065e6d76051223198baeb736/e5166/capture-flag-state-machine-water-example.jpg\"\n        srcset=\"/static/ac32a3d3065e6d76051223198baeb736/f93b5/capture-flag-state-machine-water-example.jpg 300w,\n/static/ac32a3d3065e6d76051223198baeb736/b4294/capture-flag-state-machine-water-example.jpg 600w,\n/static/ac32a3d3065e6d76051223198baeb736/e5166/capture-flag-state-machine-water-example.jpg 1200w,\n/static/ac32a3d3065e6d76051223198baeb736/d9c39/capture-flag-state-machine-water-example.jpg 1800w,\n/static/ac32a3d3065e6d76051223198baeb736/df51d/capture-flag-state-machine-water-example.jpg 2400w,\n/static/ac32a3d3065e6d76051223198baeb736/d4fe4/capture-flag-state-machine-water-example.jpg 3729w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Water cannot be both Water and Steam or Water and Ice. Ice cannot be Steam and vice versa.</p>\n<p>When the temperature of Water reaches 0℃ it freezes and turns to ice, when it reaches 100℃ it boils and turns to steam.</p>\n<p>When states and transitions can be represented in this way, a FSM is an excellent model to utilise. States, transitions and their conditions can be clearly defined and implemented, reducing the chance for error within the system and making the logic easily interpreted and understood by a human.</p>\n<p><a name=\"identifying-the-behaviours-of-capturing-a-village\"></a></p>\n<h1>Identifying the behaviours of capturing a village</h1>\n<p>A FSM is a behavioural model, and thus, before we attempt to conceptualise it, we must first understand the representative behaviours and how we go from one to another.</p>\n<p>My process for doing this is to write down a number of statements that describe the behaviours, transitions and conditions.</p>\n<p>Below, I have created some statements where I have highlighted the key words that identify either a state, condition or transition.</p>\n<ul>\n<li>\n<p>When <strong>a player</strong> comes close to an <strong>un-occupied</strong> village they can start <strong>occupying</strong> it.</p>\n</li>\n<li>\n<p><strong>A player</strong> successfully <strong>occupies</strong> a village when they have <strong>replaced</strong> the village's flag with theirs.</p>\n</li>\n<li>\n<p>If <strong>a player leaves</strong> the village before it is <strong>occupied</strong>, the village will start <strong>un-occupying</strong> itself.</p>\n</li>\n<li>\n<p>An <strong>un-occupying</strong> village will quickly return to <strong>un-occupied</strong> once it has <strong>replaced</strong> the player's flag with its own.</p>\n</li>\n<li>\n<p>When <strong>a player</strong> comes close to an <strong>un-occupying</strong> village they can start <strong>occupying</strong> it.</p>\n</li>\n<li>\n<p>A village being <strong>occupied</strong> can be <strong>contested</strong> by <strong>other players</strong>.</p>\n</li>\n</ul>\n<p><a name=\"conceptualising-our-finite-state-machine\"></a></p>\n<h1>Conceptualising our Finite State Machine</h1>\n<p>Now that we have thought about our game mechanic and how it will behave, we can visualise the State Machine by drawing a flow chart.</p>\n<p>Here is the legend:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/380bb3da630491473f56836cc2877a75/d0b12/capture-flag-state-machine-legend.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdyQsD//xAAYEAACAwAAAAAAAAAAAAAAAAABEBESIf/aAAgBAQABBQKDbV//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAAAMRAhUf/aAAgBAQAGPwJ1g4//xAAaEAACAgMAAAAAAAAAAAAAAAAAAREhMZHR/9oACAEBAAE/IXa1BqHAsW5P/9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQADAQEBAAAAAAAAAAAAAAEAESFBUYH/2gAIAQEAAT8QQCwG0b9ilTHjTIEBY6+z/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Legend\"\n        title=\"Legend\"\n        src=\"/static/380bb3da630491473f56836cc2877a75/e5166/capture-flag-state-machine-legend.jpg\"\n        srcset=\"/static/380bb3da630491473f56836cc2877a75/f93b5/capture-flag-state-machine-legend.jpg 300w,\n/static/380bb3da630491473f56836cc2877a75/b4294/capture-flag-state-machine-legend.jpg 600w,\n/static/380bb3da630491473f56836cc2877a75/e5166/capture-flag-state-machine-legend.jpg 1200w,\n/static/380bb3da630491473f56836cc2877a75/d9c39/capture-flag-state-machine-legend.jpg 1800w,\n/static/380bb3da630491473f56836cc2877a75/df51d/capture-flag-state-machine-legend.jpg 2400w,\n/static/380bb3da630491473f56836cc2877a75/d0b12/capture-flag-state-machine-legend.jpg 3596w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Here is the State Machine I devised from the above statements:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7b65e702c9bf322f40ae1b7635781537/a3e9c/capture-flag-state-machine.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 98%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAH2suDq0bIUD//EABoQAAICAwAAAAAAAAAAAAAAAAEREiEAECL/2gAIAQEAAQUCJ6lYLFyRlpXn/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGBAAAgMAAAAAAAAAAAAAAAAAEBEgITH/2gAIAQEABj8C2Fssf//EABwQAQADAAMBAQAAAAAAAAAAAAEAESEQQVExYf/aAAgBAQABPyGjePCCRTm/SVTKsaK6bhR8OnIYcITqz94//9oADAMBAAIAAwAAABDAwAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAdEAEBAAICAwEAAAAAAAAAAAABEQAhEGExQXGR/9oACAEBAAE/EFYNcAmn2YAnrQtZ3hi+8ZI4IbL3rLVDbWAAB4OFCwIAp+cf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"State Machine\"\n        title=\"State Machine\"\n        src=\"/static/7b65e702c9bf322f40ae1b7635781537/e5166/capture-flag-state-machine.jpg\"\n        srcset=\"/static/7b65e702c9bf322f40ae1b7635781537/f93b5/capture-flag-state-machine.jpg 300w,\n/static/7b65e702c9bf322f40ae1b7635781537/b4294/capture-flag-state-machine.jpg 600w,\n/static/7b65e702c9bf322f40ae1b7635781537/e5166/capture-flag-state-machine.jpg 1200w,\n/static/7b65e702c9bf322f40ae1b7635781537/d9c39/capture-flag-state-machine.jpg 1800w,\n/static/7b65e702c9bf322f40ae1b7635781537/a3e9c/capture-flag-state-machine.jpg 2020w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><a name=\"coding-our-state-machine\"></a></p>\n<h1>Coding our State Machine</h1>\n<p>Whilst my example is written for Unity, the concept can be applied to any game engine. It is worth noting that I have also translated my existing code, which is written to work for a multiplayer game using <code>Unity.Netcode</code>, into code for a standard, single player game.</p>\n<p>The basic contract for states within a State Machine is:</p>\n<ul>\n<li><strong>On enter</strong>. Provides a way for the state to perform an action(s) when it is first entered, such as play an animation or do some setup for the state.</li>\n<li><strong>On exit</strong>. Provides a way for the state to perform an action(s) prior to exiting, such as clean-up.</li>\n<li><strong>On update</strong>. Provides a way for the state to perform action(s) on each update to the frame, such as check some condition.</li>\n</ul>\n<p>Of course, this can be expanded to include any number of hooks that make sense to you.</p>\n<p>In C# an abstract class can be used to both specify a public API as well as perform anything common to all states.</p>\n<deckgo-highlight-code language=\"csharp\" line-numbers=\"true\"  >\n          <code slot=\"code\">public abstract class VillageState\n{\n  public string Name =&gt; this.ToString().Split(&#39;.&#39;).ToList().Last();\n\n  public virtual void OnEnter(IStateMachine stateMachine)\n  { }\n\n  public virtual void OnUpdate(IStateMachine stateMachine)\n  { }\n\n  public virtual void OnEnter(IStateMachine stateMachine)\n  { }\n}</code>\n        </deckgo-highlight-code>\n<p>Making the methods virtual will simplify the concrete classes and avoid you having to create empty methods when they are not needed.</p>\n<p>An example of one of our states:</p>\n<deckgo-highlight-code language=\"csharp\" line-numbers=\"true\"  >\n          <code slot=\"code\">using System.Linq;\n\npublic class UnOccupiedVillageState : VillageState\n{\n  public override void OnEnter(IStateMachine stateMachine)\n  {\n    stateMachine.PerformCoup();\n  }\n\n  public override void OnUpdate(IStateMachine stateMachine)\n  {\n    IPlayer[] occupiers = DetectOccupiers(stateMachine.VillageCentre, stateMachine.OccupyRange, stateMachine.PlayerMask);\n\n    if (occupiers.Length == 0)\n      return;\n    else if (occupiers.Length == 1)\n      stateMachine.PerformCoup(occupiers[0]);\n      stateMachine.TransitionTo(stateMachine.States.Occupying);\n    else\n      stateMachine.TransitionTo(stateMachine.States.Contested);\n  }\n\n  private IPlayer[] DetectOccupiers(float villageCentre, float occupyRange, int playerMask)\n  {\n    return Physics\n        .OverlapSphere(VillageCentre, CaptureDistance, _playerLayerMask)\n        .Select((collider) =&gt; collider.gameObject.GetComponent&lt;IPlayer&gt;())\n        .ToArray();\n  }\n}</code>\n        </deckgo-highlight-code>\n<p>In the above code sample of <strong>UnOccupiedVillageState</strong>, <code>DetectOccupiers</code> would most likely be a public method available on <code>IStateMachine</code> as it would likely be used in more than one state. It's really down to what makes sense for you. The State Machine is a construct that handles the running of the machine and provides a public interface exposing common functionality to it's states.</p>\n<p>And an example of our State Machine:</p>\n<deckgo-highlight-code language=\"csharp\" line-numbers=\"true\"  >\n          <code slot=\"code\">public class Village : MonoBehaviour, IStateMachine\n{\n  private VillageState _currentVillageState;\n  private IPlayer _occupier;\n\n  private void Awake()\n  {\n    PlayerLayerMask = 1 &lt;&lt; LayerMask.NameToLayer(&quot;Player&quot;);\n    States = new VillageStates()\n    {\n      Contested = new ContestedVillageState(),\n      Occupied = new OccupiedVillageState(),\n      Occupying = new OccupyingVillageState(),\n      UnOccupied = new UnOccupiedVillageState(),\n      UnOccupying = new UnOccupyingVillageState(),\n    };\n    _currentVillageState = States.UnOccupied;\n  }\n\n  private void Update()\n  {\n    if (_currentVillageState != default)\n      _currentVillageState.OnUpdate(this);\n  }\n\n  public void PerformCoup()\n  {\n    _occupier = default;\n  }\n\n  public void PerformCoup(IPlayer player)\n  {\n    _occupier = player;\n  }\n\n  public int PlayerLayerMask { get; internal set; }\n\n  public VillageStates States { get; internal set; }\n\n  public void TransitionToState(VillageState state)\n  {\n    if (_currentVillageState != default)\n      _currentVillageState.OnExit(this);\n\n    _currentVillageState = state;\n    _currentVillageState.OnEnter(this);\n\n    Debug.Log($&quot;Village transitioned to state {state.Name}&quot;);\n  }\n\n  public Vector3 VillageCentre =&gt; transform.position;\n}\n\npublic interface IStateMachine\n{\n  void PerformCoup();\n  void PerformCoup(IPlayer player);\n  int PlayerLayerMask { get; internal set; }\n  VillageStates States { get; internal set; }\n  void TransitionToState(VillageState state);\n  Vector3 VillageCentre { get; }\n}\n\npublic struct VillageStates\n{\n  public VillageState Contested;\n  public VillageState Occupied;\n  public VillageState Occupying;\n  public VillageState UnOccupied;\n  public VillageState UnOccupying;\n}</code>\n        </deckgo-highlight-code>\n<p><a name=\"the-end-result\"></a></p>\n<h1>The end result</h1>\n<p>Here is a gif showing the game mechanic in all its glory as it transitions through the five states we have discussed above.</p>\n<p><img src=\"/44afeeebab473db8390666d8502c2820/capture-flag-game-mechanic.gif\" alt=\"Capture Flag\"></p>\n<p>I hope this was informative and useful. Leave a comment on one of my socials. Thank you!</p>","id":"a3512ab8-0f26-5cea-aac3-27f9f93d0c7d","frontmatter":{"date":"April 09, 2022","slug":"/blog/building-capture-flag-game-mechanic","title":"Building a capture the flag game mechanic","tags":["design","architecture","pattern","development","game","unity","model"]}}},"pageContext":{"id":"a3512ab8-0f26-5cea-aac3-27f9f93d0c7d","frontmatter__slug":"/blog/building-capture-flag-game-mechanic","__params":{"frontmatter__slug":"blog"}}},
    "staticQueryHashes": []}